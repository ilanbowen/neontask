name: Application CI/CD

on:
  push:
    branches:
      - main
    paths:
      - 'app/**'
      - 'hello-world-helm/**'
      - '.github/workflows/app-deploy.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'app/**'
      - 'hello-world-helm/**'
  workflow_dispatch:

env:
  AWS_REGION: eu-north-1
  EKS_CLUSTER_NAME: hello-world-eks
  ECR_REPOSITORY: hello-world-app
  HELM_CHART_NAME: hello-world-helm

permissions:
  id-token: write
  contents: read

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: [self-hosted, eks-runner]
    outputs:
      image-tag: ${{ steps.meta.outputs.version }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./app
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false  # Disable provenance for compatibility

      - name: Image summary
        run: |
          echo "### Docker Image Built Successfully! ðŸ³" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** \`${{ steps.build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY

  package-helm:
    name: Package Helm Chart
    runs-on: [self-hosted, eks-runner]
    needs: build-and-push
    outputs:
      chart-version: ${{ steps.chart-version.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.13.0'

      - name: Get Chart Version
        id: chart-version
        run: |
          CHART_VERSION=$(grep '^version:' hello-world-helm/Chart.yaml | awk '{print $2}')
          echo "version=$CHART_VERSION" >> $GITHUB_OUTPUT
          echo "Chart version: $CHART_VERSION"

      - name: Package Helm Chart
        run: |
          helm package hello-world-helm/
          ls -lh *.tgz
          
      - name: Push Helm Chart to ECR (OCI)
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          CHART_VERSION: ${{ steps.chart-version.outputs.version }}
        run: |
          # Push to ECR OCI registry
          helm push ${HELM_CHART_NAME}-${CHART_VERSION}.tgz oci://${REGISTRY}

        

      - name: Chart summary
        env:
          CHART_VERSION: ${{ steps.chart-version.outputs.version }}
        run: |
          echo "### Helm Chart Packaged Successfully! âŽˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Chart:** \`${HELM_CHART_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${CHART_VERSION}\`" >> $GITHUB_STEP_SUMMARY

  deploy-to-eks:
    name: Deploy to EKS
    runs-on: [self-hosted, eks-runner]
    needs: [build-and-push, package-helm]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    environment: production  # Add environment protection if needed
    env:
      KUBECONFIG: /tmp/kubeconfig    
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Update kubeconfig
        run: |
          mkdir -p "$(dirname "$KUBECONFIG")"
          aws eks update-kubeconfig --name "$EKS_CLUSTER_NAME" --region "$AWS_REGION" --kubeconfig "$KUBECONFIG"
          echo "Using kubeconfig at: $KUBECONFIG"
          kubectl config get-contexts || true
          
          # Verify connection
          kubectl cluster-info
          kubectl get nodes

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.13.0'

      - name: Pre-deploy cluster check
        run: |
          echo "Nodes:"
          kubectl get nodes -o wide || true

          echo "Core namespaces:"
          kubectl get pods -n kube-system || true 

      - name: Deploy to EKS with Helm
        env:
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image-tag }}
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          echo "Deploying application to EKS..."
          echo "Image: ${REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
          
          export DATABASE_URL="${{ secrets.DATABASE_URL }}"
          echo "DATABASE_URL length: ${#DATABASE_URL}"   # safe debug (no value printed)

          set +e
          # Deploy using local Helm chart
          helm upgrade --install ${{ env.HELM_CHART_NAME }} \
            ./hello-world-helm \
            --namespace default \
            --set image.repository=${REGISTRY}/${ECR_REPOSITORY} \
            --set image.tag=${IMAGE_TAG} \
            --set image.pullPolicy=Always \
            --set-string database.url="${{ secrets.DATABASE_URL }}" \
            --wait \
            --timeout 10m
          rc=$?
          set -e
          
          if [ $rc -ne 0 ]; then
            echo "=== HELM STATUS ==="
            helm status hello-world-helm -n default || true

            echo "=== K8S RESOURCES ==="
            kubectl get deploy,rs,po,svc,ing -n default -l app.kubernetes.io/instance=hello-world-helm -o wide || true

            echo "=== EVENTS ==="
            kubectl get events -n default --sort-by=.lastTimestamp | tail -n 120 || true

            echo "=== POD DESCRIBE ==="
            POD=$(kubectl get pod -n default -l app.kubernetes.io/instance=hello-world-helm \
              --sort-by=.metadata.creationTimestamp -o jsonpath='{.items[-1].metadata.name}' 2>/dev/null || true)
            [ -n "$POD" ] && kubectl describe pod -n default "$POD" | tail -n 200 || true

            echo "=== POD LOGS (previous) ==="
            [ -n "$POD" ] && kubectl logs -n default "$POD" --previous --tail=300 || true

            exit $rc
          fi


      - name: Verify deployment
        env:
          APP_NAME: ${{ env.HELM_CHART_NAME }}
        run: |
          echo "Verifying deployment..."

          set +e
          kubectl rollout status deployment/${APP_NAME} --timeout=5m
          ROLL_STATUS=$?
          set -e

          echo "Rollout exit code: $ROLL_STATUS"

          echo "Deployments:"
          kubectl get deploy

          echo "Pods:"
          kubectl get pods -o wide

          echo "Events (last 50):"
          kubectl get events --sort-by=.lastTimestamp | tail -n 50

          exit $ROLL_STATUS


      - name: Get application URL
        id: app-url
        run: |
          # Get LoadBalancer URL (if service type is LoadBalancer)
          LB_HOSTNAME=$(kubectl get svc ${{ env.HELM_CHART_NAME }} \
            -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")
          
          if [ -n "$LB_HOSTNAME" ]; then
            echo "url=http://${LB_HOSTNAME}" >> $GITHUB_OUTPUT
            echo "Application URL: http://${LB_HOSTNAME}"
          else
            echo "url=ClusterIP (internal only)" >> $GITHUB_OUTPUT
            echo "Service is ClusterIP - internal only"
          fi

      - name: Deployment summary
        env:
          APP_URL: ${{ steps.app-url.outputs.url }}
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image-tag }}
          CHART_VERSION: ${{ needs.package-helm.outputs.chart-version }}
        run: |
          echo "### ðŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** \`${IMAGE_TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Chart Version:** \`${CHART_VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Application URL:** ${APP_URL}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Details:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -l app.kubernetes.io/name=${{ env.HELM_CHART_NAME }} >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸš€ Application Deployed Successfully!\n\n**Image:** \`${{ needs.build-and-push.outputs.image-tag }}\`\n**Chart:** \`${{ needs.package-helm.outputs.chart-version }}\``
            })