name: Build, Push, and Deploy Hello World

on:
  push:
    branches: [ "main" ]

env:
  AWS_REGION: eu-north-1
  AWS_ACCOUNT_ID: "125206151944"
  ECR_APP_REPO: "hello-world-app"
  ECR_HELM_REPO: "hello-world-helm"
  EKS_CLUSTER_NAME: "hello-world-eks"
  K8S_NAMESPACE: "hello-world"

jobs:
  build-and-push-image:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2              

      - name: Build and push Docker image
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          IMAGE_URI=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_APP_REPO:$IMAGE_TAG
          docker build -t $IMAGE_URI .
          docker push $IMAGE_URI
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

  package-and-push-chart:
    runs-on: ubuntu-latest
    needs: build-and-push-image

    permissions:
      id-token: write
      contents: read

    outputs:
      chart_version: ${{ steps.set-chart-version.outputs.chart_version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.15.4

      - name: Login to ECR as Helm OCI registry
        run: |
          aws ecr get-login-password --region $AWS_REGION \
            | helm registry login \
              -u AWS \
              --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

      - name: Package Helm chart
        working-directory: helm/hello-world
        run: |
          helm package . --destination ../../artifacts
          ls -l ../../artifacts

      - name: Determine chart version
        id: set-chart-version
        run: |
          CHART_FILE=$(ls artifacts/hello-world-*.tgz)
          CHART_VERSION=$(echo "$CHART_FILE" | sed -E 's/.*hello-world-([0-9\.]+)\.tgz/\1/')
          echo "Chart file: $CHART_FILE"
          echo "Chart version: $CHART_VERSION"
          echo "chart_version=$CHART_VERSION" >> "$GITHUB_OUTPUT"

      - name: Push Helm chart to ECR (OCI)
        run: |
          CHART_FILE=$(ls artifacts/hello-world-*.tgz)
          export HELM_EXPERIMENTAL_OCI=1
          echo "Pushing chart: $CHART_FILE"
          echo "To repo: oci://$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_HELM_REPO"
          helm push $CHART_FILE oci://$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_HELM_REPO

  deploy:
    runs-on: ubuntu-latest
    needs: package-and-push-chart

    permissions:
      id-token: write
      contents: read

    env:
      CHART_VERSION: ${{ needs.package-and-push-chart.outputs.chart_version }}

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.15.4

      - name: Login to ECR as Helm OCI registry
        run: |
          aws ecr get-login-password --region $AWS_REGION \
            | helm registry login \
              -u AWS \
              --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig \
            --name $EKS_CLUSTER_NAME \
            --region $AWS_REGION

      - name: Create namespace if not exists
        run: |
          kubectl get namespace $K8S_NAMESPACE || \
            kubectl create namespace $K8S_NAMESPACE

      - name: Deploy with Helm from ECR OCI
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Using IMAGE_TAG=$IMAGE_TAG"
          echo "Using CHART_VERSION=$CHART_VERSION"

          helm upgrade --install hello-world \
            oci://$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_HELM_REPO/hello-world \
            --version "$CHART_VERSION" \
            --namespace "$K8S_NAMESPACE" \
            --create-namespace \
            --set image.repository=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_APP_REPO \
            --set image.tag="$IMAGE_TAG"
